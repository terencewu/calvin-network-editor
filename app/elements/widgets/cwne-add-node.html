<polymer-element name="cwne-node-editor" attributes="editMode isLink">
    <template>
        <link rel="stylesheet" href="../../../../ca-water-network/app/components/leaflet/dist/leaflet.css" />
        <style>
            :host {
                display: block;
                height: 100%;
            }
            .nodePanel {
                height: 50%;
                padding: 10px;
                box-shadow: 0 0 5px black;
                position: absolute;
                width: 100%;
                z-index: 100;
                overflow: auto;
            }
        </style>

        <div id="leaflet" style="height:50%"></div>
        <div class="nodePanel">

            <h4 hidden?="{{editMode}}">Add Node</h4>
            <h4 hidden?="{{!editMode}}">Edit Node: {{properties.prmname}}</h4>
            
            <div class="alert alert-info" hidden?="{{ll && !editMode}}">
                Click map to add a new node
            </div>

            <table class="table" hidden?="{{!ll}}">
                <tr>
                    <td>Lat / Lng</td>
                    <td>{{ll.lat}}, {{ll.lng}}</td>
                </tr>
                <tr>
                    <td>Prmname</td>
                    <td>
                        <input type="text" class="form-control" value="{{properties.prmname}}" />
                        <template bind if="{{!isValidName}}">
                            <div class="alert alert-danger  animated flipInX" style="margin-top:10px">
                                Invalid PRMNAME.  A node with this prmname already exists.
                            </div>
                        </template>
                    </td>
                </tr>
                <tr>
                    <td>Type</td>
                    <td>
                        <select value="{{properties.type}}" class="form-control">
                            <template repeat="{{type in types}}">
                                <option value="{{type}}" selected?="{{type == properties.type}}">{{type}}</option>
                            </template>
                        </select>
                    </td>
                </tr>
            </table>

            <div hidden?="{{!ll || isLink}}">
                <h4 class="page-header">Add/Remove Links</h5>

                <div layout horizontal>
                    <div>Find Node to Link</div>
                    <cwne-node-search type="node" on-select="{{onLinkSelect}}"></cwne-node-search>
                </div>

                <template bind if="{{links.length > 0}}">
                    <h4 class="page-header">Current Links</h4>

                    <div>
                        <select value="{{selectedLink.index}}" class="form-control">
                            <template repeat="{{link, i in links}}">
                                <option value="{{i}}">{{link.properties.prmname}}</option>
                            </template>
                        </select>
                    </div>
                    <div>
                        <cwne-add-link 
                            link="{{selectedLink.value}}" 
                            on-delete="{{removeLink}}"
                            on-prmname-update="{{resetOriginsTerminals}}">
                        </cwne-add-link>
                    </div>
                </template>
            </div>

            <div hidden?="{{!ll || !properties.prmname}}">
                <a class="btn btn-success" on-click="{{save}}">
                    <span hidden?="{{isEdit}}">Create</span>
                    <span hidden?="{{!isEdit}}">Save</span>
                </a>
            </div>

        </div>

    </template>
    <script>
        (function(){
            var fs = requireNode('fs');

            Polymer('cwne-node-editor', {
                // has the map been initialized
                init : false,
                // leaflet map
                map : null,
                // datastore reference
                ds : null,
                // root directory
                rootDir : '',

                // markers and lines connected to editing node (leaflet)
                connected : {
                    markers : [],
                    lines : []
                },

                // currrent latlng, as leaflet object
                ll : null,
                // current leaflet marker for editing node
                marker : null,

                // known type of links/nodes
                types : [],

                // current attached links
                links : [],

                // currently visible link
                selectedLink : {
                    index : 0,
                    value : {}
                },

                // current node properties
                properties : {
                    prmname : '',
                    type : '',
                    origins : [],
                    terminals : []
                },

                // is the current PRMNAME valid?
                isValidName : true,

                // if this is edit, keep track of that the prmname started as
                originalPrmname : '',

                editMode : false,
                isLink : false,

                linkTypes : ['Diversion', 'Return Flow'],

                observe : {
                    ll : 'updateLL',
                    'properties.type' : 'redrawMarker',
                    links : 'redraw',
                    'properties.prmname' : 'onPrmUpdate',
                    'selectedLink.index' : 'updateSelected'
                },

                ready : function() {
                    Polymer.whenPolymerReady(function(){
                        this.ds = document.querySelector('html /deep/ cwn-datastore');
                    }.bind(this));
                },

                reset : function() {
                    if( this.marker ) this.map.removeLayer(this.marker);
                    for( var i = 0; i < this.connected.markers.length; i++ ) {
                        this.map.removeLayer(this.connected.markers[i]);
                    }
                    for( var i = 0; i < this.connected.lines.length; i++ ) {
                        this.map.removeLayer(this.connected.lines[i]);
                    }
                    this.connected = {
                        markers : [],
                        lines : []
                    };
                    this.ll = null;
                    this.links = [];

                    this.selectedLink = {
                        index : 0,
                        value : {}
                    };

                    this.properties = {
                        prmname : '',
                        type : '',
                        origins : [],
                        terminals : []
                    };
                },

                editNode : function(node) {
                    this.reset();
                    this.editMode = true;

                    this.originalPrmname = node.properties.prmname;
                    this.properties = node.properties;
    
                    if( this.linkTypes.indexOf(this.properties.type) > -1 ) {
                        this.isLink = true;

                    } else {
                        this.isLink = false;
                    }
                },

                onPrmUpdate : function() {
                    this.isValidName = true;
                    if( !this.editMode && ds.lookupMap[properties.prmname] ) {
                        this.isValidName = false;
                    } else if ( this.editMode && 
                        ds.lookupMap[properties.prmname] && 
                        this.properties.prmname != this.originalPrmname ) {

                        this.isValidName = false;
                    }

                    this.updateLinkNames();
                },

                onShow : function() {
                    if( !this.init ) {
                        this.init = true;

                        this.async(function(){
                            this.map = L.map(this.$.leaflet).setView([40, -121], 5); 
                            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                                maxZoom: 18
                            }).addTo(this.map);
                            this.map.on('click', this.onClick.bind(this));
                        });

                        for( var key in CWN.render ) {
                            if( key[0] != '_' && this.linkTypes.indexOf(key) == 0 ) this.types.push(key);
                        }
                        this.properties.type = this.types[0];
                    }
                },

                onLinkSelect : function(e) {
                    var node = this.ds.lookupMap[e.detail];
                    if( !node ) return alert('Error finding node');

                    var link = {
                        type : 'Feature',
                        geometry : {
                            type : 'LineString',
                            coordinates : [
                                [this.ll.lat, this.ll.lng],
                                this._flipLL(node.geometry.coordinates)
                            ]
                        },
                        properties : {
                            description : 'No description set',
                            _isOrigin    : true,
                            origin      : this.properties.prmname,
                            terminus    : node.properties.prmname, 
                            prmname     : this.properties.prmname+'-'+node.properties.prmname,
                            type        : 'Diversion'
                        }
                    };

                    this.links.push(link);
                    this.resetOriginsTerminals();
                    this.async(this.updateSelected);
                },

                updateLinkNames : function() {
                    for( var i = 0; i < this.links.length; i++ ) {
                        var l = this.links[i];
                        if( l.properties._isOrigin ) {
                            l.properties.origin = this.properties.prmname;
                        } else {
                            l.properties.terminus = this.properties.prmname;
                        }
                        l.properties.prmname = l.properties.origin+'-'+l.properties.terminus;
                    }
                    this.resetOriginsTerminals();
                },

                updateSelected : function() {
                    this.selectedLink.value = this.links[parseInt(this.selectedLink.index)];
                },

                resetOriginsTerminals : function() {
                    this.properties.origins = [];
                    this.properties.terminals = [];

                    for( var i = 0; i < this.links.length; i++ ) {
                        if( this.links[i].properties._isOrigin ) {
                            this.properties.terminals.push(this.links[i].properties.prmname);
                        } else {
                            this.properties.origins.push(this.links[i].properties.prmname);
                        }
                    }
                },

                onClick : function(e) {
                    this.ll = e.latlng;
                },

                updateLL : function() {
                    for( var i = 0; i < this.links.length; i++ ) {
                        this.links[i].geometry.coordinates[0] = [this.ll.lat, this.ll.lng];
                    }
                    this.redraw();
                },

                redraw : function() {
                    this.redrawLines();
                    this.redrawMarker();
                },

                redrawMarker : function() {
                    if( !this.ll || !this.properties.type ) return;

                    if( this.marker ) this.map.removeLayer(this.marker);

                    var options = {
                        iconSize : new L.Point(25, 25),
                        type : this.properties.type
                    };

                    this.marker = new L.Marker(this.ll, {
                        icon: new L.Icon.Canvas(options), 
                        opacity: 1
                    });

                    this.marker.addTo(this.map);
                },

                redrawLines : function() {
                    for( var i = 0; i < this.connected.markers.length; i++ ) {
                        this.map.removeLayer(this.connected.markers[i]);
                    }
                    for( var i = 0; i < this.connected.lines.length; i++ ) {
                        this.map.removeLayer(this.connected.lines[i]);
                    }

                    this.connected = {
                        markers : [],
                        lines : []
                    }

                    for( var i = 0; i < this.links.length; i++ ) {
                        var polyline = L.polyline(this.links[i].geometry.coordinates).addTo(this.map);
                        this.connected.lines.push(polyline);

                        var connectedPrmname;
                        if( this.links[i].properties.origin == this.properties.prmname ) {
                            connectedPrmname = this.links[i].properties.terminus;
                        } else {
                            connectedPrmname = this.links[i].properties.origin;
                        }

                        var n = this.ds.lookupMap[connectedPrmname];
                        if( !n ) continue;

                        var options = {
                            iconSize : new L.Point(25, 25),
                            type : n.properties.type
                        };

                        var marker = new L.Marker(this._flipLL(n.geometry.coordinates), {
                            icon: new L.Icon.Canvas(options), 
                            opacity: .5
                        });
                        marker.addTo(this.map);

                        this.connected.markers.push(marker);
                    }
                },

                removeLink : function(e) {
                    var index = this.links.indexOf(e.currentTarget.link);
                    if( index > -1 ) this.links.splice(index, 1);
                    this.resetOriginsTerminals();
                    this.updateSelected();
                },

                save : function() {
                    if( fs.existsSync(this.rootDir+'/data/nodes/'+CWN.fs.getFolderName(this.properties.prmname)) ) {
                        return alert('Invalid PRMNAME: '+this.properties.prmname);
                    }

                    for( var i = 0; i < this.links.length; i++ ) {
                        if( fs.existsSync(this.rootDir+'/data/links/'+CWN.fs.getFolderName(this.links[i].properties.prmname)) ) {
                            return alert('Invalid PRMNAME: '+this.links[i].properties.prmname);
                        }
                    }

                    var data = [];
                    var node = {
                        type : 'Feature',
                        geometry : {
                            type : 'Point',
                            coordinates : [this.ll.lng, this.ll.lat],
                        },
                        properties : this.properties
                    };
                    data.push(node);

                    for( var i = 0; i < this.links.length; i++ ) {
                        // clean up, the lat/lng are switch... grrrr
                        this.links[i].geometry.coordinates[0] = this._flipLL(this.links[i].geometry.coordinates[0]);
                        this.links[i].geometry.coordinates[1] = this._flipLL(this.links[i].geometry.coordinates[1]);

                        data.push(this.links[i]); 
                    }

                    CWN.fs.addUpdate(data, function() {
                        this.ds._processNode(node);
                        for( var i = 0; i < this.links.length; i++ ) {
                            this.ds._processLink(this.links[i]);
                        }

                        alert('Success!');
                        this.reset();
                        window.location = '#map';
                        document.querySelector('html /deep/ cwn-map').update();
                    }.bind(this));                    
                },

                _flipLL : function(ll) {
                    return [ll[1], ll[0]];
                }

            });
        })();

    </script>
</polymer-element>
<polymer-element name="cwn-schema-editor" attributes="rootDir file">
    <template>
        <template bind if="{{rootDir}}">
            <cwn-schema-object-input  
                rootDir="{{rootDir}}"
                file="{{file}}" 
                data="{{data}}"
                schema="{}"
                parentSchema="{}">
            </cwn-schema-object-input>
        </template>
    </template>
    <script>
        (function(){
            var fs = require('fs');

            Polymer('cwn-schema-editor', {
                rootDir : '',
                file : '',
                data : {},

                observe : {
                    rootDir : 'onRootDirChange'
                },

                onRootDirChange : function() {
                    CWN.schemaEditor.rootDir = this.rootDir;
                }

            });

            /** Add Global Helper Functions **/
            if( !window.CWN ) window.CWN = {};
            CWN.schemaEditor = {};

            CWN.schemaEditor.loadRef = function(ref, schema, parentSchema) {
                if( ref == '#/external' ) return CWN.schemaEditor.createExternalRefernce();

                var parts = ref.split('#'), subSchema;

                if( parts[0].length > 0 ) {
                    subSchema = CWN.schemaEditor.rootDir+'/'+parts[0];
                    
                    if( !fs.existsSync(subSchema) ) {
                        return console.log('Cant find subSchema: '+subSchema);
                    } else {
                        subSchema = fs.readFileSync(subSchema);
                        subSchema = JSON.parse(subSchema);
                    }
                } else {
                    subSchema = schema;
                }

                if( parts.length > 1 ) {
                    parts = parts[1].replace(/^\//,'').split('/');
                    resp = this.loadLocalRef(0, parts, subSchema);

                    if( resp == -1 && parentSchema ) {
                        resp = this.loadLocalRef(0, parts, parentSchema);
                    }
                    
                    if( resp == -1 ) {
                        subSchema = {};
                        console.log('Error loading local ref: ['+parts+']');
                    } else {
                        subSchema = resp;
                    }
                }

                return subSchema;
            };

            CWN.schemaEditor.loadLocalRef = function(index, parts, subSchema) {
                if( index == parts.length - 1 ) {
                    return subSchema[parts[index]];
                } else if ( subSchema[parts[index]] !== undefined ) {
                    subSchema = subSchema[parts[index]]
                    index++;
                    return this.loadLocalRef(index, parts, subSchema);
                } else {
                    return -1;
                }
            };

            CWN.schemaEditor.createExternalRefernce = function() {
                return {
                    type : 'reference'
                }
            };



        })();

    </script>
</polymer-element>
<polymer-element name="cwn-schema-object-input" attributes="rootDir file schema data key parentSchema">
    <template>
        <style>
            h4 {
                margin: 4px 0 !important;
            }
            h5 {
                margin: 3px 0 !important;
            }

            .debug {
                background-color: #f8f8f8;
                padding: 5px;
                margin: 5px;
                font-size: 11px;
            }
        </style>

        <h4>{{schema.title}}</h4>
        <h5>{{schema.description}}</h5>

        <div class="debug">{{debug}}</div>
        <template bind if="{{error}}">
            <div style="color:red">{{error}}</div>
        </template>


        <template bind if="{{oneOf.length > 0}}">
            <div layout horizontal>
                <h5>{{schema.title}} is of type:</h5>
                <div>
                    <select on-change="{{setOneOf}}">
                        <template repeat="{{type, j in oneOf}}">
                            <option value="{{j}}">{{type.title || type.type}}</option>
                        </template>
                    </select>
                </div>
            </div>
        </template>

        <template repeat="{{item, i in objProperties}}">
            <cwn-schema-input 
                data="{{data}}"
                key="{{item.key}}"
                schema="{{item.schema}}"
                parentSchema="{{item.parentSchema}}">
            </cwn-schema-input>
        </template>

        <!-- this is for pattern inputs -->
        <template repeat="{{c, i in custom}}">
            <div layout horizontal>
                <div>
                    <button index="{{i}}" on-click="{{addCustomProperty}}">Add {{c.schema.title || c.schema.type}}</button>
                </div>
                <div>
                    Name: <input type="text" value="{{c.tmpName}}" on-keypress="{{onCustomNameInput}}" index="{{i}}" />
                </div>
            </div>

            <template repeat="{{data in c.data}}">
                <div style="padding: 10px">
                    <div layout horizontal>
                        <div>
                            <div style="padding: 5px">
                                <div>{{data.key}}</div>
                                <div><a on-click="{{removeCustomProperty}}" key="{{data.key}}" index="{{i}}">Remove</a></div>
                            </div>
                        </div>
                        <div flex>
                            <cwn-schema-input 
                                data="{{data.value}}"
                                key="{{data.key}}"
                                schema="{{c.schema}}"
                                parentSchema="{{schema}}">
                            </cwn-schema-input>
                        </div>
                    </div>
                </div>
            </template>
            
        </template>
        
    </template>
    <script>
        (function(){
            var fs = require('fs');

            Polymer('cwn-schema-object-input', {
                rootDir : '',
                file : '',
                key : '',
                schema : {},
                parentSchema : {},
                
                oneOf : [],
                oneOfSelected : -1,
                anyOf : [],
                custom : [],

                // array of inherited refrences
                isA : [],

                objProperties : [],

                data : {},

                error : '',
                debug : '',

                observe : {
                    data : 'checkType'
                },

                ready : function() {
                    //console.log('Object: '+this.key);
                    //console.log(this.data);

                    this.oneOf = [];
                    this.anyOf = [];
                    this.isA = [];
                    this.objProperties = [];
                    this.custom = [];
                },

                attached : function() {
                    this.async(function(){
                        if( this.file ) {
                            this.loadSchema();
                        } 
                        if( !this.schema ) return;
                        
                        this.debug = JSON.stringify(this.schema);

                        this.inherit(this.schema, true);
                    });
                },

                checkType : function() {
                    if( typeof this.data != 'object' ) this.data = {};
                },

                loadSchema : function() {
                    var file = this.rootDir+'/'+this.file;
                    if( !fs.existsSync(file) ) {
                        this.error = 'Schema file does not exsit: '+file;
                        return;
                    }

                    var data = fs.readFileSync(file);
                    this.schema = JSON.parse(data);
                },

                inherit : function(schema, root) {

                    if( schema.properties  ) {
                        for( var key in schema.properties ) {
                            this.processProperty(key, schema.properties[key]);
                        }
                    }

                    if( schema.anyOf ) {
                        var arr = [];
                        for( var i = 0; i < schema.anyOf.length; i++ ) {
                            arr.push(this.processOneOrAnyOf(schema.anyOf[i]));
                        }
                        this.anyOf.push(arr);
                    }

                    if( schema.oneOf && root && this.oneOfSelected == -1) {
                        for( var i = 0; i < schema.oneOf.length; i++ ) {
                            this.oneOf.push(this.processOneOrAnyOf(schema.oneOf[i]));
                        }
                        this.oneOfSelected = 0;
                    } 

                    if( schema.allOf ) {
                        for( var i = 0; i < schema.allOf.length; i++ ) {
                            this.processInherit(schema.allOf[i]);
                        }
                    } 
                    
                    if( root && this.oneOfSelected != -1 ) {
                        this.processInherit(this.oneOf[this.oneOfSelected]);
                    }

                    //if( root ) {
                        this.updatePatternProps(schema);
                    //}

                },

                updatePatternProps : function(schema) {
                    if( schema.patternProperties ) {
                        var d = this.key ? this.data[this.key] : this.data;
                                   
                        for( var key in schema.patternProperties ) {
                            var regex = new RegExp(key);
                            var data = [];
                            
                            if( d ) {
                                for( var datakey in d ) {
                                    if( this.isControlledProp(datakey) || !datakey.match(regex) ) continue;
                                    
                                    data.push({
                                        key : datakey,
                                        value : d[datakey]
                                    });
                                }
                            }

                            var schema = this.processOneOrAnyOf(schema.patternProperties[key]);
                            if( !schema.type && this.isTypeObject(schema) ) schema.type = 'object';

                            this.custom.push({
                                allow : true,
                                pattern : key,
                                schema : schema,
                                data : data,
                                tmpName : ''
                            });
                        }
                        
                    }
                },

                isControlledProp : function(key) {
                    for( var i = 0; i < this.objProperties.length; i++ ) {
                        if( this.objProperties[i].key == key ) return true;
                    }
                    return false;
                },

                setOneOf : function(e) {
                    if( e ) {
                        this.oneOfSelected = parseInt(e.currentTarget.value);
                    }

                    // when our type if updated, clear everything
                    this.objProperties = [];
                    this.anyOf = [];
                    this.allOf = [];
                    this.custom = [];

                    this.inherit(this.schema, true);
                },

                processOneOrAnyOf : function(def) {
                    if( def.$ref ) {
                        return CWN.schemaEditor.loadRef(def.$ref, this.schema, this.parentSchema);
                    }

                    return def;
                },

                processInherit : function(def) {
                    if( def.$ref ) {
                        def = CWN.schemaEditor.loadRef(def.$ref, this.schema, this.parentSchema);
                    }

                    // if this is of type 'object'
                    if( !def.type && this.isTypeObject(def) ) {
                        def.type = 'object';
                    }

                    if( def.type == 'object' ) {
                        this.inherit(def, false);
                    } else {
                        this.processProperty(this.key, def);
                    }
                    
                },

                processProperty : function(key, typeDef) {
                    var prop;
                    if( typeDef.$ref ) {
                        prop = {
                            key : key,
                            schema : CWN.schemaEditor.loadRef(typeDef.$ref, this.schema, this.parentSchema),
                            parentSchema : this.schema
                        };
                    } else {
                        prop = {
                            key : key,
                            schema : typeDef,
                            parentSchema : this.schema
                        };
                    }

                    if( !prop.schema.type && this.isTypeObject(prop.schema) ) prop.schema.type = 'object';

                    this.objProperties.push(prop);
                },

                onCustomNameInput : function(e) {
                    if( e.which == 13 ) this.addCustomProperty(e);
                },

                addCustomProperty : function(e) {
                    var index = parseInt(e.currentTarget.getAttribute('index'));
                    var propDef = this.custom[index];

                    if( propDef.tmpName.length == 0 ) return alert('Please provide an attibute name');
                    if( !propDef.tmpName.match(new RegExp(propDef.pattern)) ) {
                        return alert('Invalid attribute name "'+propDef+'".  Must match: '+propDef.pattern);
                    }

                    this.data[propDef.tmpName] = '';
                    propDef.data.push({
                        key : propDef.tmpName,
                        value : ''
                    });

                    propDef.tmpName = '';
                },

                removeCustomProperty : function(e) {
                    var index = parseInt(e.currentTarget.getAttribute('index'));
                    var key = e.currentTarget.getAttribute('key');

                    var propDef = this.custom[index];
                    for( var i = 0; i < propDef.data.length; i++ ) {
                        if( propDef.data[i].key == key ) {
                            propDef.data.splice(i, 1);
                            break;
                        }
                    }

                    delete this.data[key];
                },

                isTypeObject : function(def) {
                    // if the def has a type, this is a horrible idea!

                    var objKeys = ['oneOf', 'allOf', 'anyOf', 'properties'];
                    for( var i = 0; i < objKeys.length; i++ ) {
                        if( def[objKeys[i]] ) return true;  
                    }
                    return false;
                }

            });

        })();
    </script>
</polymer-element>